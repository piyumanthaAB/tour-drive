# name: Build and Deploy to Azure

# on:
#   push:
#     branches:
#       - dev
# env:
#   IMAGE_NAME: tourdrive

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2
#       - name: Login to Azure Container Registry
#         uses: azure/docker-login@v1
#         with:
#           login-server: ${{ secrets.ACR_REGISTRY }}
#           username: ${{ secrets.ACR_USERNAME }}
#           password: ${{ secrets.ACR_PASSWORD }}
#       - name: Build Docker image
#         run: docker build . -t $IMAGE_NAME:latest
#       - name: Tag Docker image
#         run: docker tag $IMAGE_NAME:latest ${{ secrets.ACR_REGISTRY }}/$IMAGE_NAME:latest
#       - name: Push Docker image to Azure Container Registry
#         run: docker push ${{ secrets.ACR_REGISTRY }}/$IMAGE_NAME:latest

name: Build and Deploy to Railway

on:
  push:
    branches:
      - dev

env:
  RAILWAY_APP_NAME: 'tour-drive'
  DOCKER_REGISTRY: 'registry.railway.app'
  DOCKER_REGISTRY_USER: 'railway'
  IMAGE_NAME: 'tourdrive'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to Docker Registry
        run: echo "${{ secrets.RAILWAY_API_KEY }}" | docker login -u $DOCKER_REGISTRY_USER --password-stdin $DOCKER_REGISTRY
      - name: Build Docker image
        run: docker build . -t $IMAGE_NAME:latest
      - name: Tag Docker image
        run: docker tag $IMAGE_NAME:latest $DOCKER_REGISTRY/$RAILWAY_APP_NAME/$IMAGE_NAME:latest
      - name: Push Docker image to Docker Registry
        run: docker push $DOCKER_REGISTRY/$RAILWAY_APP_NAME/$IMAGE_NAME:latest
      - name: Deploy to Railway
        uses: railwayapp/actions@v0.4.0
        with:
          command: deploy $RAILWAY_APP_NAME --image $DOCKER_REGISTRY/$RAILWAY_APP_NAME/$IMAGE_NAME:latest
        env:
          RAILWAY_API_KEY: ${{ secrets.RAILWAY_API_KEY }}
